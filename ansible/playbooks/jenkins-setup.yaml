---
# Main playbook for Jenkins server setup

- name: Configure Jenkins Server
  hosts: jenkins
  gather_facts: yes
  become: yes
  vars_files:
    - ../group_vars/all.yaml

  pre_tasks:
    - name: Display target hosts
      debug:
        msg: "Configuring {{ inventory_hostname }} ({{ ansible_host }})"
      tags: always

    - name: Wait for system to be ready
      wait_for_connection:
        delay: 5
        timeout: 300
      tags: always

    - name: Gather facts
      setup:
      tags: always
  
    - name: Detect package manager type
      raw: |
        if command -v dnf &> /dev/null; then
          dnf --version 2>&1 | head -1
        elif command -v yum &> /dev/null; then
          echo "yum"
        else
          echo "unknown"
        fi
      register: pkg_manager_detect
      changed_when: false
      tags: always

    - name: Set global package manager facts
      set_fact:
        use_dnf: "{{ 'dnf' in pkg_manager_detect.stdout }}"
        use_dnf5: "{{ 'dnf5' in pkg_manager_detect.stdout }}"
        use_dnf4: "{{ 'dnf4' in pkg_manager_detect.stdout or ('dnf' in pkg_manager_detect.stdout and 'dnf5' not in pkg_manager_detect.stdout) }}"
        dnf_backend: "{{ 'dnf5' if 'dnf5' in pkg_manager_detect.stdout else 'dnf4' }}"
      tags: always
  roles:
    - role: common
      tags:
        - common
        - base

    - role: java
      tags:
        - java
        - jenkins-deps

    - role: git
      tags:
        - git
        - jenkins-deps

    - role: docker
      tags:
        - docker
        - jenkins-deps

    - role: jenkins
      tags:
        - jenkins

  post_tasks:
    - name: Display completion message
      debug:
        msg:
          - "=========================================="
          - "Jenkins Setup Complete!"
          - "=========================================="
          - "Jenkins URL: http://{{ ansible_host }}:{{ jenkins_port }}"
          - "SSH: ssh -i vockey.pem ec2-user@{{ ansible_host }}"
          - "Check /home/ec2-user/jenkins-info.txt for details"
          - "=========================================="
      tags: always

    - name: Create summary file
      copy:
        content: |
          Jenkins Configuration Summary
          =============================
          
          Configuration Date: {{ ansible_date_time.iso8601 }}
          Hostname: {{ ansible_hostname }}
          IP Address: {{ ansible_host }}
          
          Installed Components:
          - Java: {{ java_version }}
          - Docker: Installed
          - Git: Installed
          - Jenkins: {{ jenkins_version }}
          
          Services Status:
          - Docker: Active
          - Jenkins: Active on port {{ jenkins_port }}
          
          Next Steps:
          1. Access Jenkins at http://{{ ansible_host }}:{{ jenkins_port }}
          2. Use initial admin password from jenkins-info.txt
          3. Configure Jenkins plugins and settings
          
        dest: /home/ec2-user/ansible-summary.txt
        owner: ec2-user
        group: ec2-user
        mode: '0644'
      tags: always

