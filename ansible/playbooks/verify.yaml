---
# Verification playbook to check all installations

- name: Verify Jenkins Server Configuration
  hosts: tag_Project_CloudDevOpsProject
  gather_facts: yes
  become: yes

  tasks:
    - name: Check Java installation
      command: java -version
      register: java_check
      changed_when: false
      ignore_errors: yes

    - name: Check Git installation
      command: git --version
      register: git_check
      changed_when: false
      ignore_errors: yes

    - name: Check Docker installation
      command: docker --version
      register: docker_check
      changed_when: false
      ignore_errors: yes

    - name: Check Docker service status
      systemd:
        name: docker
      register: docker_service
      ignore_errors: yes

    - name: Check Jenkins installation
      command: systemctl status jenkins
      register: jenkins_check
      changed_when: false
      ignore_errors: yes

    - name: Check Jenkins service status
      systemd:
        name: jenkins
      register: jenkins_service
      ignore_errors: yes

    - name: Test Jenkins web interface
      uri:
        url: "http://localhost:8080"
        status_code: 200,403
      register: jenkins_web
      ignore_errors: yes

    - name: Check if initial admin password exists
      stat:
        path: /var/lib/jenkins/secrets/initialAdminPassword
      register: jenkins_password_file

    - name: Display verification results
      debug:
        msg:
          - "=========================================="
          - "Verification Results"
          - "=========================================="
          - "Java: {{ 'OK' if java_check.rc == 0 else 'FAILED' }}"
          - "Git: {{ 'OK' if git_check.rc == 0 else 'FAILED' }}"
          - "Docker: {{ 'OK' if docker_check.rc == 0 else 'FAILED' }}"
          - "Docker Service: {{ docker_service.status.ActiveState | default('UNKNOWN') }}"
          - "Jenkins: {{ 'OK' if jenkins_check.rc == 0 else 'FAILED' }}"
          - "Jenkins Service: {{ jenkins_service.status.ActiveState | default('UNKNOWN') }}"
          - "Jenkins Web: {{ 'OK' if jenkins_web.status == 200 or jenkins_web.status == 403 else 'FAILED' }}"
          - "Admin Password File: {{ 'EXISTS' if jenkins_password_file.stat.exists else 'NOT FOUND' }}"
          - "=========================================="

    - name: Get Jenkins initial password
      slurp:
        src: /var/lib/jenkins/secrets/initialAdminPassword
      register: jenkins_password
      when: jenkins_password_file.stat.exists

    - name: Display Jenkins password
      debug:
        msg: "Jenkins Initial Admin Password: {{ jenkins_password.content | b64decode }}"
      when: jenkins_password_file.stat.exists